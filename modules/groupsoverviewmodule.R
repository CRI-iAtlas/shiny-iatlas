groupsoverview_UI <- function(id) {
    ns <- NS(id)
    
    tagList(
        titleBox("iAtlas Explorer — Sample Groups Overview"),
        textBox(
            width = 12,
            p("This module provides short summaries of your selected groups, and allows you to see how they overlap with other groups.")  
        ),
        sectionBox(
            title = "Select groups",
            messageBox(
                width = 12,
                p("Select groups here")  
            ),
            fluidRow(
                optionsBox(
                    width = 8,
                    fileInput(
                        ns("file1"),
                        "Choose CSV File",
                        multiple = FALSE,
                        accept = c("text/csv",
                                   "text/comma-separated-values,text/plain",
                                   ".csv")
                    ),
                    DT::dataTableOutput(
                        ns("user_group_df")),
                    style = "color:black"
                )
            )
        ),
        sectionBox(
            title = "Group Key",
            messageBox(
                width = 12,
                p("This displays attributes and annotations of your choice of groups.")  
            ),
            fluidRow(
                tableBox(
                    width = 12,
                    title = textOutput(ns("sample_group_name")),
                    div(style = "overflow-x: scroll",
                        DT::dataTableOutput(ns("sample_group_table")) %>% 
                            shinycssloaders::withSpinner()
                    )
                )
            )
        ),
        sectionBox(
            title = "Group Overlap",
            messageBox(
                width = 12,
                p("This displays the overlap between the grouping you are looking at (“first” sample grouping), and an alternate grouping (“second” sample grouping), as so-called mosaic plot.  In the mosaic plot, each column represents grouping by the alternate method, and the proportion of samples falling into your primary group choice are shown proportionally within that column. The width of the column reflects the number of samples in the alternate groups."), 
                p("Manuscript context: Figure 1D can be generated by selecting Immune Subtype in the top left as the primary group, and “TCGA Study” with the radio buttons below, as the alternate grouping. Figure S1B corresponds to the opposite choice, and you can generate a mosaic plot for the BRCA subtypes in Figure S1B using this method.")
            ),
            fluidRow(
                optionsBox(
                    width = 8,
                    uiOutput(ns("mosaic_group_select"))
                ),
                uiOutput(ns("study_subset_select"))
            ),
            fluidRow(
                plotBox(
                    width = 12,
                    column(
                        width = 12,
                        plotlyOutput(ns("mosaicPlot"), height = "600px") %>% 
                            shinycssloaders::withSpinner()
                    )
                )
            )
        )
    )
}

groupsoverview <- function(
    input, output, session, group_display_choice, group_internal_choice, 
    subset_df, plot_colors, group_options, width) {
    
    ns <- session$ns
    
    sample_groups <- reactive(get_category_group(group_internal_choice()))
    
    output$sample_group_name <- renderText({
        paste(group_display_choice(), "Groups")
    })
    
    output$sample_group_table <- DT::renderDT({
        build_sample_group_key_df(
            df = subset_df(),
            group_option = group_internal_choice()
        ) %>% 
            datatable(
                options = list(
                    dom = "tip",
                    pageLength = 10,
                    columnDefs = list(
                        list(width = '50px', targets = c(1))
                    )
                ),
                rownames = FALSE
            ) %>%
            formatStyle(
                "Plot Color",
                backgroundColor = styleEqual(
                    plot_colors(), 
                    plot_colors()
                )
            )
    })
    
    output$mosaic_group_select <- renderUI({
        choices <- setdiff(group_options(), group_display_choice())
        
        
        radioButtons(ns("sample_mosaic_group"), 
                     "Select second sample group to view overlap:",
                     choices = choices,
                     selected = choices[1],
                     inline = TRUE)
    })
    
    output$study_subset_select <- renderUI({
        
        req(input$sample_mosaic_group, cancelOutput = TRUE)
        
        if (input$sample_mosaic_group == "TCGA Subtype") {
            choices <- panimmune_data$sample_group_df %>% 
                filter(sample_group == "tcga_subtype", !is.na(FeatureValue)) %>% 
                distinct(`TCGA Studies`) %>% 
                extract2("TCGA Studies")
            
            optionsBox(
                width = 4,
                selectInput(ns("study_subset_selection"), 
                            "Choose study subset:",
                            choices = choices,
                            selected = NULL)
            )
        }
    })
    
    output$mosaicPlot <- renderPlotly({
        
        req(input$sample_mosaic_group, input$study_subset_selection,
            cancelOutput = T)
        
        display_x  <- input$sample_mosaic_group
        display_y  <- group_display_choice()
        internal_x <- get_group_internal_name(display_x)
        internal_y <- group_internal_choice()

        mosaic_df <- build_mosaic_plot_df(
            subset_df(),
            x_column = internal_x,
            y_column = internal_y,
            study_option = input$study_subset_selection,
            user_group_df()) 
        
        create_mosaicplot(
            mosaic_df,
            x = internal_x,
            y = internal_y,
            fill_factor = internal_y,
            title = str_c(display_y, "by", display_x, sep = " "),
            fill_colors = decide_plot_colors(panimmune_data, internal_y)) 
    })
    
    user_group_df <- reactive({
        req(input$file1)
        tryCatch(
            {
                df <- readr::read_csv(input$file1$datapath)
            },
            error = function(e) {
                stop(safeError(e))
            }
        )
        return(df)
        
    })
    
    output$user_group_df <- DT::renderDataTable(user_group_df())
    return(user_group_df)
    
}

